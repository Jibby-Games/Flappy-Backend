services:
  # Game Server Manager
  manager:
    container_name: manager
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    tty: true
    networks:
      - frontend
      - monitoring
    environment:
      - DOCKER_USER=${GAME_MANAGER_DOCKER_USER:-jibby}
      - DOCKER_REPO=${GAME_MANAGER_DOCKER_REPO:-flappyrace}
      - SECRETS_VOLUME=${GAME_MANAGER_SECRETS_VOLUME:-flappy-backend_nginx_secrets}
      - MAX_CONTAINER_RETRIES=${GAME_MANAGER_MAX_CONTAINER_RETRIES:-10}
      - MAX_RUNNING_SERVERS=${GAME_MANAGER_MAX_RUNNING_SERVERS:-20}
      - MAX_TAGS=${GAME_MANAGER_MAX_TAGS:-5}

  # Game Server List
  list:
    container_name: list
    tty: true
    networks:
      - frontend
      - monitoring
    environment:
      - IP_SOURCE=XRealIp

  # Reverse Proxy
  proxy:
    container_name: proxy
    build: proxy
    volumes:
      - nginx_secrets:/etc/letsencrypt
      - ./proxy/user_conf.d:/etc/nginx/user_conf.d:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - frontend
      - monitoring
    environment:
      - CERTBOT_EMAIL=${CERTBOT_EMAIL}
    depends_on:
      - manager
      - list

  # Metrics Storage
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    networks:
      - monitoring
    command:
      - '--storage.tsdb.retention.time=1y'
      - '--storage.tsdb.retention.size=4GB'
      # Default commands from image:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./metrics/config:/etc/prometheus/:ro
      - prometheus-data:/prometheus

  # Metrics Viewer
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    networks:
      - frontend
      - monitoring
    volumes:
      - grafana-data:/var/lib/grafana
      # Stores datasources and exported dashboards
      - ./metrics/provisioning:/etc/grafana/provisioning:ro
      # Optional config file
      # - ./grafana.ini:/etc/grafana/grafana.ini:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=https://${HOST_DOMAIN:-localhost}/grafana/

  # System Metrics Source
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    networks:
      - monitoring
    command:
      - '--path.rootfs=/host'
    pid: host
    restart: unless-stopped

  # Container Log Viewer
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    networks:
      - frontend
      - monitoring
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./dozzle/data:/data
    environment:
      DOZZLE_AUTH_PROVIDER: simple
      DOZZLE_BASE: /dozzle

volumes:
  nginx_secrets: {}
  prometheus-data: {}
  grafana-data: {}

networks:
  # Frontend network - Services accessible through the proxy
  frontend:
    driver: bridge
    internal: false
  # Monitoring network - Metrics collection and viewing (isolated from public)
  monitoring:
    driver: bridge
    internal: true
